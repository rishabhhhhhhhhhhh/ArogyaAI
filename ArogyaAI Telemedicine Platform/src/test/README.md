# Property-Based Testing Setup

This directory contains the property-based testing framework configuration for the WebRTC Video Calling System.

## Overview

Property-based testing (PBT) is used to verify that the WebRTC system satisfies correctness properties across all valid inputs, complementing traditional unit tests. The framework uses [fast-check](https://github.com/dubzzz/fast-check) for property generation and testing.

## Files

### Core Files

- **`setup.ts`** - Main test setup file with WebRTC mocks and fast-check configuration
- **`property-generators.ts`** - Generators for WebRTC-specific test data
- **`property-test-utils.ts`** - Utilities and patterns for property-based testing

### Test Files

- **`__tests__/property-setup.test.ts`** - Verification tests for the PBT framework setup

## Configuration

The property-based testing framework is configured with:

- **100 iterations minimum** per property test (as specified in design document)
- **10 second timeout** for property tests
- **Fixed seed (42)** for reproducible tests in CI
- **WebRTC API mocks** for browser APIs not available in jsdom

## Usage

### Creating Property Tests

Use the `createPropertyTest` utility for consistent configuration:

```typescript
import { createPropertyTest } from '../test/property-test-utils';
import { sessionDataGenerator } from '../test/property-generators';

createPropertyTest(
  'session creation should be complete',
  fc.property(sessionDataGenerator(), (session) => {
    // Test logic here
    return true;
  })
);
```

### Using Generators

Import generators from `property-generators.ts`:

```typescript
import { 
  sessionDataGenerator,
  chatMessageGenerator,
  iceServerGenerator 
} from '../test/property-generators';

// Use in property tests
fc.property(sessionDataGenerator(), (session) => {
  // Test with generated session data
});
```

### Property Patterns

Use common patterns from `property-test-utils.ts`:

```typescript
import { PropertyPatterns } from '../test/property-test-utils';

// Round-trip property
const roundTripProperty = PropertyPatterns.roundTrip(
  generator,
  serialize,
  deserialize
);

// Idempotent property
const idempotentProperty = PropertyPatterns.idempotent(
  generator,
  operation
);

// Invariant property
const invariantProperty = PropertyPatterns.invariant(
  generator,
  operation,
  invariantCheck
);
```

## Property Test Requirements

Each property-based test must:

1. **Run minimum 100 iterations** (configured globally)
2. **Be tagged with design document reference**:
   ```typescript
   // **Feature: webrtc-video-calling, Property 1: Session Creation Completeness**
   ```
3. **Validate specific correctness properties** from the design document
4. **Use realistic test data** generated by the provided generators

## Available Generators

### Basic Generators
- `sessionIdGenerator()` - UUID session identifiers
- `userIdGenerator()` - UUID user identifiers  
- `userRoleGenerator()` - 'doctor' | 'patient'
- `jwtTokenGenerator()` - JWT token strings

### WebRTC Generators
- `sessionDataGenerator()` - Complete session objects
- `chatMessageGenerator()` - Chat message objects
- `sdpGenerator()` - SDP offer/answer objects
- `iceCandidateGenerator()` - ICE candidate objects
- `iceServerGenerator()` - ICE server configurations
- `webrtcConfigGenerator()` - Complete WebRTC configurations

### Complex Generators
- `signalingMessageGenerator()` - Signaling protocol messages
- `authDataGenerator()` - Authentication data
- `networkQualityGenerator()` - Network quality metrics
- `completeSessionGenerator()` - Sessions with participants and messages

## Assertion Helpers

Use `PropertyAssertions` for common validation patterns:

```typescript
import { PropertyAssertions } from '../test/property-test-utils';

PropertyAssertions.validSession(session);
PropertyAssertions.validChatMessage(message);
PropertyAssertions.validIceServerConfig(config);
PropertyAssertions.validSignalingMessage(message);
PropertyAssertions.validAuthData(authData);
```

## Mock Factory

Use `MockFactory` for consistent WebRTC mocks:

```typescript
import { MockFactory } from '../test/property-test-utils';

const mockPeerConnection = MockFactory.createMockPeerConnection();
const mockWebSocket = MockFactory.createMockWebSocket();
const mockMediaStream = MockFactory.createMockMediaStream();
```

## Running Property Tests

```bash
# Run all tests
npm run test

# Run specific property test file
npm run test:run path/to/property.test.ts

# Run with UI
npm run test:ui
```

## Design Document Integration

This property-based testing setup implements the testing strategy specified in the design document:

- **Dual testing approach**: Unit tests + Property tests
- **Fast-check library**: As specified for JavaScript/TypeScript
- **100+ iterations**: Minimum iteration count for thorough testing
- **Property tagging**: Each test references design document properties
- **Realistic generators**: Smart generators for WebRTC domain

## Correctness Properties

The following correctness properties from the design document should be implemented as property-based tests:

1. **Session Creation Completeness** (Requirements 1.1, 1.2)
2. **Signaling Round-trip Integrity** (Requirements 1.3, 1.4, 1.5)
3. **Authenticated Session Access** (Requirements 2.1, 4.1, 4.2)
4. **Connection Establishment with Fallback** (Requirements 2.2, 2.3, 2.4, 5.1, 5.2, 5.3)
5. **Media Stream UI Integration** (Requirements 2.5, 7.1, 7.2)
6. **Chat Message Handling Completeness** (Requirements 3.1, 3.2, 3.3, 3.4, 3.5)
7. **Secure Communication Protocol** (Requirements 4.3, 4.4)
8. **Session Cleanup Integrity** (Requirements 4.5, 6.4)
9. **Network Adaptation Resilience** (Requirements 5.4, 5.5)
10. **Minimal Server Logic Compliance** (Requirements 6.1, 6.2, 6.3, 6.5)
11. **UI Integration Preservation** (Requirements 7.3, 7.4, 7.5)

Each property should be implemented as a separate property-based test with appropriate generators and assertions.